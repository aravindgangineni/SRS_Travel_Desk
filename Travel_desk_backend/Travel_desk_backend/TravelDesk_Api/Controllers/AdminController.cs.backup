using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using Microsoft.EntityFrameworkCore;
using TravelDesk_Api.Models;
using System.Security.Claims;
using System.Text;
using BCrypt.Net;

namespace TravelDesk_Api.Controllers
{
    // Corrected DTO to accept plain-text password
    public class AddUserDto
    {
        public string Email { get; set; }
        public string Password { get; set; } // Renamed from PasswordHash
        public int RoleId { get; set; }
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
        public string? EmployeeId { get; set; }
        public string? Department { get; set; }
        public int? ManagerId { get; set; }
    }

    // New DTO for updating user information
    public class EditUserDto
    {
        public string? Email { get; set; }
        public string? Password { get; set; }
        public int? RoleId { get; set; }
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
        public string? EmployeeId { get; set; }
        public string? Department { get; set; }
        public int? ManagerId { get; set; }
    }

    [Route("api/[controller]")]
    [ApiController]
    [Authorize(Roles = "Admin")]
    public class AdminController : ControllerBase
    {
        private readonly TravelDeskContext _context;

        public AdminController(TravelDeskContext context)
        {
            _context = context;
        }

        // View a user grid with all required details and the total user count
        [HttpGet("users")]
        public async Task<IActionResult> GetUsers()
        {
            var users = await _context.Users.Include(u => u.Role)
                                             .Include(u => u.Manager)
                                             .Select(u => new
                                             {
                                                 u.UserId,
                                                 u.FirstName,
                                                 u.LastName,
                                                 u.EmployeeId,
                                                 u.Department,
                                                 Role = u.Role.RoleName,
                                                 u.RoleId,
                                                 ManagerName = u.Manager != null ? u.Manager.FirstName + " " + u.Manager.LastName : "N/A"
                                             })
                                             .ToListAsync();
            var totalUsers = await _context.Users.CountAsync();
            return Ok(new { TotalUsers = totalUsers, Users = users });
        }

        // Add a new user
        [HttpPost("add-user")]
        public async Task<IActionResult> AddUser([FromBody] AddUserDto userDto)
        {
            // Manual validation for required fields
            if (string.IsNullOrEmpty(userDto.Email) || string.IsNullOrEmpty(userDto.Password))
            {
                return BadRequest("Email and Password are required.");
            }

            var user = new User
            {
                Email = userDto.Email,
                // Correctly hash the plain-text password
                PasswordHash = Encoding.UTF8.GetBytes(BCrypt.Net.BCrypt.HashPassword(userDto.Password)),
                RoleId = userDto.RoleId,
                FirstName = userDto.FirstName,
                LastName = userDto.LastName,
                EmployeeId = userDto.EmployeeId,
                Department = userDto.Department,
                ManagerId = userDto.ManagerId
            };

            _context.Users.Add(user);
            await _context.SaveChangesAsync();
            return Ok(user);
        }

        // Edit/update user information
        [HttpPut("edit-user/{id}")]
        public async Task<IActionResult> EditUser(int id, [FromBody] EditUserDto updatedUserDto)
        {
            var userToUpdate = await _context.Users.FindAsync(id);
            if (userToUpdate == null)
            {
                return NotFound();
            }

            // Update properties only if a new value is provided
            userToUpdate.Email = updatedUserDto.Email ?? userToUpdate.Email;
            userToUpdate.FirstName = updatedUserDto.FirstName ?? userToUpdate.FirstName;
            userToUpdate.LastName = updatedUserDto.LastName ?? userToUpdate.LastName;
            userToUpdate.EmployeeId = updatedUserDto.EmployeeId ?? userToUpdate.EmployeeId;
            userToUpdate.Department = updatedUserDto.Department ?? userToUpdate.Department;

            // Update ID-based fields only if a value is provided
            if (updatedUserDto.RoleId.HasValue) userToUpdate.RoleId = updatedUserDto.RoleId.Value;
            if (updatedUserDto.ManagerId.HasValue) userToUpdate.ManagerId = updatedUserDto.ManagerId.Value;
            if (!string.IsNullOrEmpty(updatedUserDto.Password))
            {
                userToUpdate.PasswordHash = Encoding.UTF8.GetBytes(BCrypt.Net.BCrypt.HashPassword(updatedUserDto.Password));
            }

            await _context.SaveChangesAsync();
            return Ok(userToUpdate);
        }

        // Delete a user
        [HttpDelete("delete-user/{id}")]
        public async Task<IActionResult> DeleteUser(int id)
        {
            var userToDelete = await _context.Users.FindAsync(id);
            if (userToDelete == null)
            {
                return NotFound();
            }
            _context.Users.Remove(userToDelete);
            await _context.SaveChangesAsync();
            return NoContent();
        }
    }
}
        // Setup endpoint to initialize system with roles and users
        [HttpPost("setup")]
        public async Task<IActionResult> SetupSystem()
        {
            try
            {
                // Create roles if they don't exist
                var roles = new[] { "Employee", "Manager", "HR Travel Admin", "Admin" };
                foreach (var roleName in roles)
                {
                    if (!await _context.Roles.AnyAsync(r => r.RoleName == roleName))
                    {
                        _context.Roles.Add(new Role { RoleName = roleName });
                    }
                }
                await _context.SaveChangesAsync();

                // Get role IDs
                var adminRole = await _context.Roles.FirstAsync(r => r.RoleName == "Admin");
                var managerRole = await _context.Roles.FirstAsync(r => r.RoleName == "Manager");
                var travelAdminRole = await _context.Roles.FirstAsync(r => r.RoleName == "HR Travel Admin");
                var employeeRole = await _context.Roles.FirstAsync(r => r.RoleName == "Employee");

                // Create admin user if doesn't exist
                if (!await _context.Users.AnyAsync(u => u.Email == "admin@company.com"))
                {
                    _context.Users.Add(new User
                    {
                        Email = "admin@company.com",
                        PasswordHash = BCrypt.Net.BCrypt.HashBytes(Encoding.UTF8.GetBytes("admin123")),
                        RoleId = adminRole.RoleId,
                        FirstName = "System",
                        LastName = "Admin",
                        EmployeeId = "ADM001",
                        Department = "IT"
                    });
                }

                // Create travel admin user if doesn't exist
                if (!await _context.Users.AnyAsync(u => u.Email == "traveladmin@company.com"))
                {
                    _context.Users.Add(new User
                    {
                        Email = "traveladmin@company.com",
                        PasswordHash = BCrypt.Net.BCrypt.HashBytes(Encoding.UTF8.GetBytes("travel123")),
                        RoleId = travelAdminRole.RoleId,
                        FirstName = "Travel",
                        LastName = "Admin",
                        EmployeeId = "TA001",
                        Department = "HR"
                    });
                }

                // Create manager user if doesn't exist
                if (!await _context.Users.AnyAsync(u => u.Email == "manager@company.com"))
                {
                    _context.Users.Add(new User
                    {
                        Email = "manager@company.com",
                        PasswordHash = BCrypt.Net.BCrypt.HashBytes(Encoding.UTF8.GetBytes("manager123")),
                        RoleId = managerRole.RoleId,
                        FirstName = "Test",
                        LastName = "Manager",
                        EmployeeId = "MGR001",
                        Department = "Operations"
                    });
                }

                await _context.SaveChangesAsync();

                return Ok(new { Message = "System setup completed successfully!" });
            }
            catch (Exception ex)
            {
                return BadRequest(new { Error = ex.Message });
            }
        }
